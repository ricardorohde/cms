<?php    include_once("dbconfig.php");    include_once("functions.php");    function addCalendar($st, $et, $sub, $ade)    {        $ret = array();        try {            $db = new DBConnection();            $db->getConnection();            $sql = "insert into `jqcalendar` (`subject`, `starttime`, `endtime`, `isalldayevent`) values ('"            . $sub . "', '"            . php2MySqlTime(js2PhpTime($st)) . "', '"            . php2MySqlTime(js2PhpTime($et)) . "', '"            . $ade . "' )";            if (mysql_query($sql) == false)            {                $ret['IsSuccess'] = false;                $ret['Msg'] = mysql_error();            }            else            {                $ret['IsSuccess'] = true;                $ret['Msg'] = 'add success';                $ret['Data'] = mysql_insert_id();            }        } catch (Exception $e) {            $ret['IsSuccess'] = false;            $ret['Msg'] = $e->getMessage();        }        return $ret;    }    function addDetailedCalendar($st, $et, $sub, $ade, $dscr, $loc, $color, $tz)    {        $ret = array();        try {            $db = new DBConnection();            $db->getConnection();            $sql = "insert into `jqcalendar` (`subject`, `starttime`, `endtime`, `isalldayevent`, `description`, `location`, `color`) values ('"            . $sub . "', '"            . php2MySqlTime(js2PhpTime($st)) . "', '"            . php2MySqlTime(js2PhpTime($et)) . "', '"            . $ade . "', '"            . $dscr . "', '"            . $loc . "', '"            . $color . "' )";            if (mysql_query($sql) == false)            {                $ret['IsSuccess'] = false;                $ret['Msg'] = mysql_error();            }            else            {                $ret['IsSuccess'] = true;                $ret['Msg'] = 'add success';                $ret['Data'] = mysql_insert_id();            }        } catch (Exception $e) {            $ret['IsSuccess'] = false;            $ret['Msg'] = $e->getMessage();        }        return $ret;    }    function listCalendarByRange($sd, $ed)    {        $ret = array();        $ret['events'] = array();        $ret["issort"] = true;        $ret["start"] = php2JsTime($sd);        $ret["end"] = php2JsTime($ed);        $ret['error'] = null;        try {            $db = new DBConnection();            $db->getConnection();            $sql = "select * from `jqcalendar` where `starttime` between '"            . php2MySqlTime($sd) . "' and '" . php2MySqlTime($ed) . "'";            $handle = mysql_query($sql);                        while ($row = mysql_fetch_object($handle))            {                $ret['events'][] = array(                    $row->Id,                    $row->Subject,                    php2JsTime(mySql2PhpTime($row->StartTime)),                    php2JsTime(mySql2PhpTime($row->EndTime)),                    $row->IsAllDayEvent,                    0,                    0,                    $row->Color,                    1,                    $row->Location,                    ''                );            }        } catch (Exception $e) {            $ret['error'] = $e->getMessage();        }        return $ret;    }    function listCalendar($day, $type)    {        $phpTime = js2PhpTime($day);        switch ($type)        {            case "month":                $st = mktime(0, 0, 0, date("m", $phpTime), 1, date("Y", $phpTime));                $et = mktime(0, 0, -1, date("m", $phpTime) + 1, 1, date("Y", $phpTime));                break;            case "week":                $monday = date("d", $phpTime) - date('N', $phpTime) + 1;                $st = mktime(0, 0, 0, date("m", $phpTime), $monday, date("Y", $phpTime));                $et = mktime(0, 0, -1, date("m", $phpTime), $monday + 7, date("Y", $phpTime));                break;            case "day":                $st = mktime(0, 0, 0, date("m", $phpTime), date("d", $phpTime), date("Y", $phpTime));                $et = mktime(0, 0, -1, date("m", $phpTime), date("d", $phpTime) + 1, date("Y", $phpTime));                break;        }        return listCalendarByRange($st, $et);    }    function updateCalendar($id, $st, $et)    {        $ret = array();        try {            $db = new DBConnection();            $db->getConnection();            $sql = "update `jqcalendar` set"            . " `starttime`='" . php2MySqlTime(js2PhpTime($st)) . "', "            . " `endtime`='" . php2MySqlTime(js2PhpTime($et)) . "' "            . "where `id`=" . $id;            if (mysql_query($sql) == false)            {                $ret['IsSuccess'] = false;                $ret['Msg'] = mysql_error();            }            else            {                $ret['IsSuccess'] = true;                $ret['Msg'] = 'Succefully';            }        } catch (Exception $e) {            $ret['IsSuccess'] = false;            $ret['Msg'] = $e->getMessage();        }        return $ret;    }    function updateDetailedCalendar($id, $st, $et, $sub, $ade, $dscr, $loc, $color, $tz)    {        $ret = array();        try {            $db = new DBConnection();            $db->getConnection();            $sql = "update `jqcalendar` set"            . " `starttime`='" . php2MySqlTime(js2PhpTime($st)) . "', "            . " `endtime`='" . php2MySqlTime(js2PhpTime($et)) . "', "            . " `subject`='" . $sub . "', "            . " `isalldayevent`='" . $ade . "', "            . " `description`='" . $dscr . "', "            . " `location`='" . $loc . "', "            . " `color`='" . $color . "' "            . "where `id`=" . $id;            if (mysql_query($sql) == false)            {                $ret['IsSuccess'] = false;                $ret['Msg'] = mysql_error();            }            else            {                $ret['IsSuccess'] = true;                $ret['Msg'] = 'Succefully';            }        } catch (Exception $e) {            $ret['IsSuccess'] = false;            $ret['Msg'] = $e->getMessage();        }        return $ret;    }    function removeCalendar($id)    {        $ret = array();        try {            $db = new DBConnection();            $db->getConnection();            $sql = "delete from `jqcalendar` where `id`=" . $id;            if (mysql_query($sql) == false)            {                $ret['IsSuccess'] = false;                $ret['Msg'] = mysql_error();            }            else            {                $ret['IsSuccess'] = true;                $ret['Msg'] = 'Succefully';            }        } catch (Exception $e) {            $ret['IsSuccess'] = false;            $ret['Msg'] = $e->getMessage();        }        return $ret;    }    header('Content-type:text/javascript;charset=UTF-8');    $method = $_GET["method"];    switch ($method)    {        case "add":            $ret = addCalendar($_POST["CalendarStartTime"], $_POST["CalendarEndTime"], $_POST["CalendarTitle"], $_POST["IsAllDayEvent"]);            break;        case "list":            $ret = listCalendar($_POST["showdate"], $_POST["viewtype"]);            break;        case "update":            $ret = updateCalendar($_POST["calendarId"], $_POST["CalendarStartTime"], $_POST["CalendarEndTime"]);            break;        case "remove":            $ret = removeCalendar($_POST["calendarId"]);            break;        case "adddetails":            $st = $_POST["stpartdate"] . " " . $_POST["stparttime"];            $et = $_POST["etpartdate"] . " " . $_POST["etparttime"];            if (isset($_GET["id"]))            {                $ret = updateDetailedCalendar($_GET["id"], $st, $et, $_POST["Subject"], isset($_POST["IsAllDayEvent"]) ? 1 : 0, $_POST["Description"], $_POST["Location"], $_POST["colorvalue"], $_POST["timezone"]);            }            else            {                $ret = addDetailedCalendar($st, $et, $_POST["Subject"], isset($_POST["IsAllDayEvent"]) ? 1 : 0, $_POST["Description"], $_POST["Location"], $_POST["colorvalue"], $_POST["timezone"]);            }            break;    }    echo json_encode($ret);?>